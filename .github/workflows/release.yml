name: Build & Release

on:
  workflow_dispatch:
    inputs:
      patch-level:
        type: choice
        default: patch
        required: true
        description: Release Level
        options:
          - major
          - minor
          - patch
  push:
    branches:
      - main

env:
  targets: '["aarch64-unknown-linux-gnu", "x86_64-unknown-linux-gnu"]'

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build
    strategy:
      matrix:
        arch: ${{ fromJSON(env.targets) }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: '1'
          submodules: 'recursive'

      - uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Build
        run: cargo build --release --target ${{ matrix.arch }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libamdgpu-${{ case(matrix.arch == 'aarch64-unknown-linux-gnu', 'arm64', 'amd64') }}.so
          path: 'target/release/libamdgpu.so'
          retention-days: 1


  tag:
    needs: build
    runs-on: ubuntu-latest
    name: Tag
    outputs:
      tag: ${{steps.tag.outputs.new_tag}}
    steps:
      - uses: mathieudutour/github-tag-action@v6.2
        id: tag
        with:
          default_bump: ${{inputs.patch-level || 'patch'}}
          github_token: ${{ github.token }}

  release:
    runs-on: ubuntu-latest
    needs: [tag, build]
    name: Release
    strategy:
      matrix:
        arch: ${{ fromJSON(env.targets) }}

    steps:
      - name: Fetch Objects
        uses: actions/download-artifact@v7

      - name: Upload Artifacts
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: '*.so'
          tag_name: ${{ needs.tag.outputs.tag }}